<!DOCTYPE html>
<html>
  <head>
    <style>
      body {
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100vh;
        /* background and foreground colors based on a clean darkmode */
        /* give it a mono font */
        background-color: #1e1e1e;
        color: #d4d4d4;
        font-family: "Courier New", Courier, monospace;
      }
      #drop_zone {
        border: 2px dashed #bbb;
        border-radius: 20px;
        width: 400px;
        height: 200px;
        line-height: 200px;
        text-align: center;
        font-size: 20px;
        cursor: pointer;
        margin: 50px;
      }

      #drop_zone:hover {
        background-color: #1b1b1b;
      }

      /* Style the dropdown */
      select {
        width: 200px;
        height: 40px;
        margin-right: 10px;
        border: none;
        border-radius: 5px;
        padding: 10px;
        font-size: 16px;
        background-color: #f2f2f2;
        color: #333;
        cursor: pointer;
      }

      /* Style the button */
      button {
        height: 40px;
        border: none;
        border-radius: 5px;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #e26600;
        color: white;
        cursor: pointer;
      }

      /* Change the button color on hover */
      button:hover {
        background-color: #bb5400;
      }

      #output {
        display: flex;
        width: 80%;
        overflow: auto;
        margin-top: 50px;
        margin-bottom: 50px;
      }
      /* Add styles for the table */
      table {
        border-collapse: collapse; /* remove space between borders */
        margin-bottom: 50px;
      }

      /* Add styles for the table cells */
      table td,
      table th {
        border: 1px solid #ddd; /* add border to cells */
        padding: 8px; /* add some padding */
      }

      /* Add styles for the table headers */
      table th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: #e26600; /* change background color */
        color: white; /* change text color */
      }
    </style>
  </head>
  <body>
    <div id="drop_zone">Drop file or click to search</div>
    <input type="file" id="file_input" style="display: none" accept=".txt" />
    <div id="output"></div>

    <script>
      let dropZone = document.getElementById("drop_zone");
      let output = document.getElementById("output");
      let fileInput = document.getElementById("file_input");

      dropZone.onclick = function () {
        fileInput.click();
      };

      fileInput.onchange = function () {
        let files = fileInput.files;
        processFiles(files);
      };

      dropZone.ondrop = function (event) {
        event.preventDefault();
        this.style.backgroundColor = "transparent";

        let files = event.dataTransfer.files;
        processFiles(files);
      };

      dropZone.ondragover = function (event) {
        event.preventDefault();
        this.style.backgroundColor = "#ccc";
      };

      dropZone.ondragleave = function () {
        this.style.backgroundColor = "transparent";
      };

      // Fetch the worlds data when the page loads
      fetch("worlds.json") // replace 'worlds.json' with the path to your JSON file
        .then((response) => response.json())
        .then((data) => {
          // Create a div to hold the dropdown and the button
          let div = document.createElement("div");

          // Create a select element
          let select = document.createElement("select");

          // Create a placeholder option
          let placeholder = document.createElement("option");
          placeholder.value = "";
          placeholder.text = "Select World";
          placeholder.disabled = true;
          placeholder.selected = true;
          select.appendChild(placeholder);

          // Create an option for each world
          data.forEach((world) => {
            let option = document.createElement("option");
            option.value = world.id;
            option.text = world.name;
            select.appendChild(option);
          });

          // Append the select element to the div
          div.appendChild(select);

          // Create download CSV button
          let button = document.createElement("button");
          button.innerText = "Download CSV";
          button.onclick = function () {
            let table = document.getElementById("myTable"); // ensure table is defined and refers to your table
            let csv = [];
            for (let i = 0; i < table.rows.length; i++) {
              let row = [];
              for (let j = 0; j < table.rows[i].cells.length; j++) {
                let cellValue = table.rows[i].cells[j].innerText;
                cellValue = cellValue.replace(/[\r\n]+/g, " "); // remove newline characters
                if (j === 1) {
                  // if this is the "Amount" column
                  cellValue = cellValue.trim(); // remove trailing and leading whitespaces
                }
                row.push(cellValue);
              }
              csv.push(row.join("|")); // use "|" as the separator
            }
            let csvString = csv.join("\n");
            let blob = new Blob([csvString], {
              type: "text/csv;charset=utf-8;",
            });
            let url = URL.createObjectURL(blob);
            let link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "output.csv");
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          };

          // Append the button to the div
          div.appendChild(button);

          // Insert the div after the dropzone
          dropZone.parentNode.insertBefore(div, dropZone.nextSibling);
        })
        .catch((error) => console.error("Error:", error));

      // Fetch the JSON data when the page loads
      fetch("items.json") // replace 'items.json' with the path to your JSON file
        .then((response) => response.json())
        .then((data) => (jsonData = data))
        .catch((error) => console.error("Error:", error));

      function processFiles(files) {
        output.innerHTML = ""; // clear the output div
        for (let i = 0; i < files.length; i++) {
          let file = files[i];
          if (file.type == "text/plain") {
            let reader = new FileReader();
            reader.onload = function (e) {
              let text = e.target.result;
              let lines = text.split("\n");
              let furnitureIndex = lines.indexOf("Furniture");
              let dyesIndex = lines.indexOf("Dyes");
              let items = lines.slice(furnitureIndex + 2, dyesIndex - 1);
              let table = document.createElement("table");

              table.id = "myTable"; // assign an id to the table

              // Create table header
              let headerRow = document.createElement("tr");
              [
                "Item",
                "Amount",
                "ID",
                "Is Craftable?",
                "Is Purchasable?",
                "Buy From Vendor Price",
                "Is Sold In Square Store?",
                "Is Tradable?",
                "Acquisition",
              ].forEach(function (header) {
                let headerCell = document.createElement("th");
                headerCell.innerText = header;
                headerRow.appendChild(headerCell);
              });
              table.appendChild(headerRow);

              // Create table body
              items.forEach(function (itemLine) {
                let [itemName, itemAmount] = itemLine.split(": ");
                let itemData = jsonData.find(
                  (item) => item.name === itemName.trim()
                );
                if (itemData) {
                  let row = document.createElement("tr");
                  [
                    itemName,
                    itemAmount,
                    itemData.id,
                    itemData["is craftable?"],
                    itemData["is purchasable?"],
                    itemData["buy from vendor price"],
                    itemData["is sold in square store?"],
                    itemData["is tradable?"],
                    itemData.acqusition,
                  ].forEach(function (value) {
                    let cell = document.createElement("td");
                    cell.innerText = value;
                    row.appendChild(cell);
                  });
                  table.appendChild(row);
                }
              });
              output.appendChild(table); // append the table to the output div here
            };
            reader.readAsText(file);
          }
        }
      }
    </script>
  </body>
</html>
